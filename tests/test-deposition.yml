---
- name: test that the defaults are correctly placed
  hosts: localhost
  roles:
    - role: ../../ansible-unixodbc-cfg

  post_tasks:
    - name: verify that .odbc.ini is deposited
      stat:
        path: /home/{{ ansible_user }}/.odbc.ini
      register: response
      failed_when: not response.stat.exists or response.stat.pw_name != ansible_user


- name: test defer
  hosts: localhost
  vars:
    test_dir: /tmp/testdefer

  pre_tasks:
    - name: create test folder
      file:
        path: "{{ test_dir }}"
        state: directory

  roles:
    - role: ../../ansible-unixodbc-cfg
      vars:
        unixodbc_cfg_defer: true
        unixodbc_cfg_odbcini_path: "{{ test_dir }}"

  post_tasks:
    - name: verify that .odbc.ini isn't deposited
      stat:
        path: "{{ test_dir }}/.odbc.ini"
      register: response
      failed_when: response.stat.exists


- name: test that file placed in custom location
  hosts: localhost
  roles:
    - role: ../../ansible-unixodbc-cfg
      vars:
        unixodbc_cfg_odbcini_path: /tmp

  post_tasks:
    - name: verify that .odbc.ini is deposited
      stat:
        path: /tmp/.odbc.ini
      register: response
      failed_when: not response.stat.exists or response.stat.pw_name != ansible_user


- name: test that a custom user can be set
  hosts: localhost
  become: true
  roles:
    - role: ../../ansible-unixodbc-cfg
      vars:
        unixodbc_cfg_user: user

  post_tasks:
    - name: verify that .odbc.ini is deposited
      stat:
        path: /home/user/.odbc.ini
      register: response
      failed_when: not response.stat.exists or response.stat.pw_name != 'user'
